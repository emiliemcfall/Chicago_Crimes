<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v5.min.js"></script>
<style>

body {
	padding-top: 45px;
	font: 14px arial;
	width: 650px;
	margin:auto;
}
polyline {
	opacity: .3;
	stroke: black;
	stroke-width: 2px;
	fill: none;
}

</style>
</head>

<body>

Choose year
<select id="options"></select>

<div id="chart"></div>

<script>

var server = [
	{year: "2018", male: 17, female: 31},
	{year: "2017", male: 99, female: 20},
];

chart(server)

function chart(result) {

	var years = [...new Set(result.map(d => d.year))];

	var keys = Object.keys(result[0]).slice(1)

	result.forEach((d, i) => d[keys[i]] = +d[keys[i]])

	var option = d3.select("#options").selectAll("option")
		.data(years)
	.enter().append("option")
		.text(d => d)

	var width = 460,
		height = 320;

	var outerRadius = height / 2 - 30,
		innerRadius = outerRadius / 3,
		radius = Math.min(width, height) / 2;

	var pie = d3.pie().sort(null);

	var arc = d3.arc()
		.padRadius(outerRadius)
		.innerRadius(radius * 0.4)
		.cornerRadius(10);

	var outerArc = d3.arc()
		.innerRadius(radius * 0.99)
		.outerRadius(radius * 0.99);

	var color = d3.scaleOrdinal()
		.range(["purple", "steelblue"]);

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height)
	.append("g")
		.attr("transform",
			"translate(" + width / 2 + "," + height / 2 + ")");

	var lines = svg.append("g");

	var label = svg.append("g");

	update(d3.select("#options").property("value"), 0)

	function update(year, speed) {

		var data = result.filter(f => f.year == year);

		var total = Object.values(data[0]).slice(1);

		var donut = svg.selectAll(".donut")
			.data(pie(total));

		donut.exit().remove();

		donut.enter().append("path")
			.attr("class", "donut")
			.attr("stroke", "#fff")
			.attr("stroke-width", 5)
			.attr("fill", (_, i) => color(i))
			.merge(donut)
		.transition().duration(750)
			.each(function(d) { d.outerRadius = outerRadius - 10; })
			.attrTween("d", donutTween);

		var polyline = lines.selectAll("polyline")
			.data(pie(total));

		polyline.exit().remove();

		polyline.enter().append("polyline")
			.attr("class", "lines")
			.merge(polyline)
		.transition().duration(speed)
			.each(function(d) { d.outerRadius = outerRadius - 10; })
			.attrTween("points", polyTween);

		var text = label.selectAll("text")
			.data(pie(total));

		text.exit().remove();

		text.enter().append("text")
			.attr("dy", ".35em")
			.attr("font-size", 14)
			.attr("text-anchor", "middle")
			.merge(text)
		.transition().duration(speed)
			.attrTween("transform", outerTween)
			.text(d => d.value)
	}

	function donutTween(a) {
		var i = d3.interpolate(this._current, a);
		this._current = i(0);
		return t => arc(i(t))
	}

	function polyTween(d) {
		var i = d3.interpolate(this._current, d);
		this._current = i(0);
		return function(t) {
			var d2 = i(t);
			var pos = outerArc.centroid(d2);
			pos[0] = radius * 1.1 * (mid(d2) < Math.PI ? 1 : -1);
			return [arc.centroid(d2),
					outerArc.centroid(d2),
					pos];
		};
	}

	function outerTween(d) {
		this._current = this._current || d;
		var i = d3.interpolate(this._current, d);
		this._current = i(0);
		return function(t) {
			var d2 = i(t);
			var pos = outerArc.centroid(d2);
			pos[0] = radius * 1.2 * (mid(d2) < Math.PI ? 1 : -1);
			return "translate("+ pos +")";
		};
	}

	function mid(d) {
		return d.startAngle + (d.endAngle - d.startAngle) / 2;
	}

	var onHover = d3.selectAll(".donut")
		.on("mouseover", function() {
			d3.select(this).transition().attrTween("d", function(d) {
		  		var i = d3.interpolate(d.outerRadius, outerRadius);
		  		return t => { d.outerRadius = i(t); return arc(d)}
			});
		})
		.on("mouseout", function() {
			d3.select(this).transition().attrTween("d", function(d) {
				var i = d3.interpolate(d.outerRadius, outerRadius  - 10);
				return t => { d.outerRadius = i(t); return arc(d)}
			});
		})

	var options = d3.select("#options")
		.style("padding", "1px 3px 1px 3px")
		.style("border-radius", "5px")
		.on("change", function() {
			update(this.value, 750)
		});
}

</script>
</body>
